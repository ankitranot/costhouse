<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Construction Cost</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; color: #000; background: #fff; }
  h2 { font-weight: bold; font-size: 24px; margin-bottom: 20px; text-align: center; }
  .form-group { margin-bottom: 10px; }
  input, button, select { padding: 8px; margin-right: 5px; font-size: 14px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 15px; }
  th, td { border: 1px solid #000; padding: 8px; text-align: center; }
  th { background: #f2f2f2; }
  .history { margin-top: 10px; font-size: 13px; text-align: left; }
  .grand-total { font-weight: bold; font-size: 20px; text-align: center; margin-bottom: 20px; border: 2px solid #000; display: inline-block; padding: 10px 20px; }
  details { cursor: pointer; }
  @media(max-width:768px){
    input, button, select { width: 100%; margin-bottom: 8px; }
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Construction Cost</h2>
<div class="grand-total" id="grandTotalBox">Grand Total: 0</div>

<div class="form-group">
  <input type="text" id="category" placeholder="Category Name">
  <input type="number" id="cost" placeholder="Total Cost">
  <input type="number" id="paid" placeholder="Paid Amount">
  <input type="text" id="person" placeholder="Person Name">
  <button onclick="addOrUpdateRecord()">Add / Update</button>
</div>

<div class="form-group">
  <label>Filter by Person:</label>
  <select id="filterPerson" onchange="renderTable()">
    <option value="all">All</option>
  </select>
</div>

<table id="recordsTable">
  <thead>
    <tr>
      <th>Person</th>
      <th>Category</th>
      <th>Total Cost</th>
      <th>Paid</th>
      <th>Left</th>
      <th>Remarks</th>
      <th>History</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // ---------------- Firebase Setup ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyBV7tHimRYOI-zEN-4eythyPc39bafLHVY",
    authDomain: "costhouse25.firebaseapp.com",
    projectId: "costhouse25",
    storageBucket: "costhouse25.firebasestorage.app",
    messagingSenderId: "1031854363789",
    appId: "1:1031854363789:web:2db3e48f1c774a12297ec4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let records = [];

  // ---------------- Add or Update Record ----------------
  async function addOrUpdateRecord() {
    const category = document.getElementById("category").value.trim();
    const cost = parseFloat(document.getElementById("cost").value) || 0;
    const paid = parseFloat(document.getElementById("paid").value) || 0;
    const person = document.getElementById("person").value.trim();

    if (!person || !category || cost <= 0) {
      alert("Please fill all required fields (Person, Category, Cost).");
      return;
    }

    // Check if person exists in Firestore
    const querySnapshot = await db.collection("records").where("person", "==", person).get();

    if (!querySnapshot.empty) {
      // Person exists â†’ update
      const docRef = querySnapshot.docs[0].ref;
      const data = querySnapshot.docs[0].data();
      const newTotal = data.total + cost;
      const newPaid = data.paid + paid;
      const newLeft = newTotal - newPaid;
      const newCategories = [...data.categories, category];
      const newHistory = [...data.history, `+${paid} paid on ${new Date().toLocaleString()} for ${category}`];

      await docRef.update({
        total: newTotal,
        paid: newPaid,
        left: newLeft,
        categories: newCategories,
        history: newHistory,
        remarks: newLeft === 0 ? "Nil" : ""
      });
    } else {
      // New record
      await db.collection("records").add({
        person,
        total: cost,
        paid: paid,
        left: cost - paid,
        remarks: (cost - paid) === 0 ? "Nil" : "",
        categories: [category],
        history: [`+${paid} paid on ${new Date().toLocaleString()} for ${category}`]
      });
    }

    document.getElementById("category").value = "";
    document.getElementById("cost").value = "";
    document.getElementById("paid").value = "";
    document.getElementById("person").value = "";
  }

  // ---------------- Load Records Live ----------------
  db.collection("records").onSnapshot(snapshot => {
    records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    updateFilterOptions();
    renderTable();
  });

  function updateFilterOptions() {
    const filterSelect = document.getElementById("filterPerson");
    const persons = [...new Set(records.map(r => r.person))];
    filterSelect.innerHTML = '<option value="all">All</option>';
    persons.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      filterSelect.appendChild(opt);
    });
  }

  function renderTable() {
    const tbody = document.querySelector("#recordsTable tbody");
    tbody.innerHTML = "";
    const filter = document.getElementById("filterPerson").value;

    records.forEach((record) => {
      if (filter !== "all" && record.person !== filter) return;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${record.person}</td>
        <td>${record.categories.join(", ")}</td>
        <td>${record.total}</td>
        <td>${record.paid}</td>
        <td>${record.left}</td>
        <td>${record.remarks}</td>
        <td>
          <details>
            <summary>Show History</summary>
            <div class="history">${record.history.join("<br>")}</div>
          </details>
        </td>
        <td>
          <button onclick="updateRow('${record.id}')">Update</button>
          <button onclick="deleteRow('${record.id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });

    const totalSum = records.reduce((sum, r) => sum + r.total, 0);
    document.getElementById("grandTotalBox").textContent = "Grand Total: " + totalSum;
  }

  async function deleteRow(id) {
    if (confirm("Delete this record?")) {
      await db.collection("records").doc(id).delete();
    }
  }

  async function updateRow(id) {
    const addCost = parseFloat(prompt("Enter additional cost:")) || 0;
    const addPaid = parseFloat(prompt("Enter additional paid amount:")) || 0;
    const addCategory = prompt("Enter category name for this update:").trim();

    if (addCost <= 0 && addPaid <= 0) return;

    const docRef = db.collection("records").doc(id);
    const docSnap = await docRef.get();
    if (!docSnap.exists) return;

    const data = docSnap.data();
    const newTotal = data.total + addCost;
    const newPaid = data.paid + addPaid;
    const newLeft = newTotal - newPaid;
    const newCategories = [...data.categories, addCategory || "Updated"];
    const newHistory = [...data.history, `+${addPaid} paid on ${new Date().toLocaleString()} for ${addCategory || "Updated"}`];

    await docRef.update({
      total: newTotal,
      paid: newPaid,
      left: newLeft,
      categories: newCategories,
      history: newHistory,
      remarks: newLeft === 0 ? "Nil" : ""
    });
  }
</script>
</body>
</html>
