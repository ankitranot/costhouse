<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>House Cost of Construction</title>
<style>
body {
  font-family: Arial, sans-serif; margin: 0; padding: 15px;
  background: #eef2f7;
}
.container {
  max-width: 1000px; margin: auto; background: #fff;
  padding: 20px; border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
h1 {
  text-align: center; margin-bottom: 15px;
  font-size: 24px; color: #333;
  border-bottom: 2px solid #0077cc;
  display: inline-block; padding-bottom: 5px;
}
.total-box {
  text-align: center; font-size: 20px;
  font-weight: bold; margin-bottom: 15px;
  padding: 12px; background: #0077cc; color: #fff;
  border-radius: 8px;
}
.form-group {
  margin-bottom: 12px; display: flex; align-items: center; flex-wrap: wrap;
}
label {
  width: 130px; font-weight: bold; color: #333;
}
input, select {
  padding: 8px 10px; flex: 1;
  border: 1px solid #ccc; border-radius: 6px;
}
input:focus, select:focus {
  border-color: #0077cc; outline: none;
  box-shadow: 0 0 5px rgba(0,119,204,0.2);
}
button {
  padding: 8px 12px; margin: 4px;
  cursor: pointer; border: none;
  border-radius: 6px; font-weight: bold;
  transition: all 0.2s;
}
button:hover { opacity: 0.9; }
.btn-update { background: #ff9800; color: #fff; }
.btn-delete { background: #f44336; color: #fff; }
.btn-export { background: #4caf50; color: #fff; }
.table-wrapper {
  width: 100%; overflow-x: auto; margin-top: 15px;
}
table {
  width: 100%; border-collapse: collapse; min-width: 700px;
  border-radius: 8px; overflow: hidden;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
th, td {
  border: none; padding: 10px; text-align: center;
}
thead { background: #0077cc; color: #fff; }
tbody tr { background: #f9f9f9; }
tbody tr:nth-child(even) { background: #f1f3f6; }
tbody tr:hover { background: #e0f0ff; }
tfoot td { font-weight: bold; background: #ddd; }
.history {
  font-size: 12px; color: #555; margin-top: 5px;
  display: none; text-align: left;
}
.show-history-btn {
  font-size: 12px; padding: 3px 6px;
  margin-top: 3px; cursor: pointer;
  background: #ccc; border-radius: 4px;
}
.show-history-btn:hover { background: #bbb; }

/* Mobile adjustments */
@media (max-width: 768px) {
  .form-group { flex-direction: column; align-items: flex-start; }
  label { width: 100%; margin-bottom: 5px; }
  input, select { width: 100%; }
  button { width: 100%; margin: 6px 0; }
  .total-box { font-size: 18px; }
  h1 { font-size: 20px; }
}
</style>
</head>
<body>
<div class="container">
<h1>House Cost of Construction</h1>

<div class="total-box">
  Total Amount: <span id="grandTotalTop">0</span>
</div>

<!-- Form -->
<div class="form-group"><label>Material:</label><input type="text" id="material"></div>
<div class="form-group"><label>Person:</label><input type="text" id="person"></div>
<div class="form-group"><label>Total Cost:</label><input type="number" id="totalCost"></div>
<div class="form-group"><label>Amount Paid:</label><input type="number" id="amountPaid"></div>
<div class="form-group">
  <button onclick="addRecord()">Add Record</button>
  <button class="btn-export" onclick="exportExcel()">Export Excel</button>
  <button class="btn-export" onclick="exportPDF()">Export PDF</button>
</div>

<!-- Filter -->
<div class="form-group">
  <label>Filter Person:</label>
  <select id="personFilter" onchange="renderTable()">
    <option value="">All</option>
  </select>
</div>

<!-- Table -->
<div class="table-wrapper">
<table id="recordsTable">
<thead>
<tr>
<th>Date</th><th>Material</th><th>Person</th>
<th>Total Cost</th><th>Paid</th><th>Left</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td colspan="3">Grand Total</td>
<td id="grandTotal">0</td>
<td id="grandPaid">0</td>
<td id="grandLeft">0</td>
<td></td>
</tr>
</tfoot>
</table>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
let records = JSON.parse(localStorage.getItem("constructionRecords")) || [];
function saveRecords(){localStorage.setItem("constructionRecords", JSON.stringify(records));}
function updatePersonFilter(){
  const select=document.getElementById("personFilter");
  const selected=select.value;
  const persons=[...new Set(records.map(r=>r.person))].sort();
  select.innerHTML='<option value="">All</option>';
  persons.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p; opt.textContent=p; select.appendChild(opt);
  });
  if([...select.options].some(o=>o.value===selected)) select.value=selected;
}
function toggleHistory(id){
  const div=document.getElementById(id);
  div.style.display=div.style.display==='none'?'block':'none';
}
function renderTable(){
  const tbody=document.querySelector("#recordsTable tbody");
  tbody.innerHTML=""; let total=0,paid=0,left=0;
  const filter=document.getElementById("personFilter").value;
  const filtered=filter?records.filter(r=>r.person===filter):records;
  filtered.forEach((rec,i)=>{
    const tr=document.createElement("tr");
    const leftAmt=rec.totalCost-rec.amountPaid;
    const historyId="history-"+i;
    const histHTML=rec.history?rec.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join('<br>'):'';
    tr.innerHTML=`
      <td>${rec.date}</td><td>${rec.material}</td><td>${rec.person}</td>
      <td>${rec.totalCost}</td>
      <td>${rec.amountPaid}
        <div class="show-history-btn" onclick="toggleHistory('${historyId}')">Show History</div>
        <div class="history" id="${historyId}">${histHTML}</div>
      </td>
      <td>${leftAmt}</td>
      <td>
        <button class="btn-update" onclick="updatePaid(${records.indexOf(rec)})">Add Paid</button>
        <button class="btn-delete" onclick="deleteRecord(${records.indexOf(rec)})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
    total+=rec.totalCost; paid+=rec.amountPaid; left+=leftAmt;
  });
  document.getElementById("grandTotal").textContent=total;
  document.getElementById("grandPaid").textContent=paid;
  document.getElementById("grandLeft").textContent=left;
  document.getElementById("grandTotalTop").textContent=total;
  updatePersonFilter();
}
function addRecord(){
  const material=document.getElementById("material").value.trim();
  const person=document.getElementById("person").value.trim();
  const totalCost=parseFloat(document.getElementById("totalCost").value)||0;
  const amountPaid=parseFloat(document.getElementById("amountPaid").value)||0;
  if(!material||!person){alert("Please enter Material and Person name.");return;}
  const today=new Date().toLocaleDateString("en-GB");
  const rec={date:today,material,person,totalCost,amountPaid,history:[{date:today,added:amountPaid,amountPaid:amountPaid}]};
  records.push(rec); saveRecords(); renderTable();
  document.getElementById("material").value="";
  document.getElementById("person").value="";
  document.getElementById("totalCost").value="";
  document.getElementById("amountPaid").value="";
}
function updatePaid(index){
  const addPaid=prompt("Enter amount to add to Paid Amount:","0");
  if(addPaid!==null){
    const added=parseFloat(addPaid)||0;
    records[index].amountPaid+=added;
    const today=new Date().toLocaleDateString("en-GB");
    if(!records[index].history)records[index].history=[];
    records[index].history.push({date:today,added:added,amountPaid:records[index].amountPaid});
    saveRecords(); renderTable();
  }
}
function deleteRecord(index){
  if(confirm("Are you sure to delete this record?")){
    records.splice(index,1); saveRecords(); renderTable();
  }
}
function getTotals(arr=records){
  let total=0,paid=0,left=0;
  arr.forEach(r=>{total+=r.totalCost;paid+=r.amountPaid;left+=r.totalCost-r.amountPaid;});
  return {total,paid,left};
}
function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws_data=[["Date","Material","Person","Total Cost","Paid","Left","History"]];
  const filter=document.getElementById("personFilter").value;
  const exportRecords=filter?records.filter(r=>r.person===filter):records;
  exportRecords.forEach(r=>{
    const historyStr=r.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join("\n");
    ws_data.push([r.date,r.material,r.person,r.totalCost,r.amountPaid,r.totalCost-r.amountPaid,historyStr]);
  });
  ws_data.push(["Grand Total","","",getTotals(exportRecords).total,getTotals(exportRecords).paid,getTotals(exportRecords).left,""]);
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Records");
  XLSX.writeFile(wb,"Construction_Records.xlsx");
}
function exportPDF(){
  const {jsPDF}=window.jspdf; const doc=new jsPDF();
  doc.text("House Cost of Construction",14,15);
  const filter=document.getElementById("personFilter").value;
  const exportRecords=filter?records.filter(r=>r.person===filter):records;
  const tableData=exportRecords.map(r=>[
    r.date,r.material,r.person,r.totalCost,r.amountPaid,r.totalCost-r.amountPaid,
    r.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join("\n")
  ]);
  tableData.push(["Grand Total","","",getTotals(exportRecords).total,getTotals(exportRecords).paid,getTotals(exportRecords).left,""]);
  doc.autoTable({head:[["Date","Material","Person","Total Cost","Paid","Left","History"]],body:tableData,startY:20});
  doc.save("Construction_Records.pdf");
}
renderTable();
</script>
</body>
</html>
