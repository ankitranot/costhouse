<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>House Cost of Construction</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {font-family:"Segoe UI",sans-serif;margin:0;padding:0;background:#f4f6f9;color:#333;font-size:17px;}
    header {background:#0077cc;color:#fff;padding:15px;text-align:center;font-size:22px;font-weight:bold;}
    .container {max-width:1000px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
    .form-group {display:flex;flex-wrap:wrap;margin-bottom:15px;gap:10px;}
    .form-group input {flex:1;padding:12px;border:1px solid #ccc;border-radius:8px;font-size:17px;}
    button {background:#0077cc;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-size:17px;}
    button:hover {background:#005fa3;}
    .summary-box {background:#0077cc;color:white;padding:18px;border-radius:12px;margin-bottom:20px;text-align:center;font-size:20px;font-weight:bold;}
    table {width:100%;border-collapse:collapse;margin-top:20px;font-size:16px;}
    th,td {border:1px solid #ddd;padding:12px;text-align:center;}
    th {background:#0077cc;color:white;font-size:16px;}
    tr:nth-child(even){background:#f9f9f9;}
    .history {font-size:15px;color:#444;text-align:left;}
    .export-buttons {margin-top:20px;display:flex;flex-wrap:wrap;gap:10px;}
    .export-buttons button {flex:1;min-width:140px;}
    @media(max-width:768px){.form-group{flex-direction:column;}th,td{font-size:15px;padding:10px;}.summary-box{font-size:18px;padding:15px;}button{width:100%;}}
  </style>
</head>
<body>
  <header>House Cost of Construction</header>
  <div class="container">
    <div class="summary-box">Total Amount: <span id="grandTotal">0</span></div>

    <div class="form-group">
      <input type="text" id="material" placeholder="Material / Item">
      <input type="text" id="person" placeholder="Person Name">
      <input type="number" id="cost" placeholder="Total Cost">
      <input type="number" id="paid" placeholder="Amount Paid">
      <button onclick="addRecord()">Add</button>
    </div>

    <div class="form-group">
      <label for="personFilter"><b>Filter by Person:</b></label>
      <select id="personFilter" onchange="renderTable()"><option value="">All</option></select>
    </div>

    <table id="recordsTable">
      <thead>
        <tr>
          <th>Date</th><th>Material</th><th>Person</th><th>Total Cost</th><th>Paid</th><th>Left</th><th>History</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="export-buttons">
      <button onclick="exportExcel()">Export Excel</button>
      <button onclick="exportPDF()">Export PDF</button>
    </div>
  </div>

<script>
let records=[];

function addRecord(){
  const material=document.getElementById("material").value;
  const person=document.getElementById("person").value;
  const cost=parseFloat(document.getElementById("cost").value)||0;
  const paid=parseFloat(document.getElementById("paid").value)||0;
  if(!material||!person||cost<=0){alert("Please fill material, person, and cost.");return;}
  const date=new Date().toLocaleDateString();
  const record={date,material,person,totalCost:cost,amountPaid:paid,history:[{date,added:paid,amountPaid:paid}]};
  records.push(record);
  updatePersonFilter(); renderTable();
  document.getElementById("material").value="";document.getElementById("person").value="";
  document.getElementById("cost").value="";document.getElementById("paid").value="";
}

function updatePersonFilter(){
  const filter=document.getElementById("personFilter");
  const persons=[...new Set(records.map(r=>r.person))];
  filter.innerHTML='<option value="">All</option>';
  persons.forEach(p=>{const opt=document.createElement("option");opt.value=p;opt.textContent=p;filter.appendChild(opt);});
}

function renderTable(){
  const tbody=document.querySelector("#recordsTable tbody");tbody.innerHTML="";
  const filterPerson=document.getElementById("personFilter").value;
  let total=0;
  records.filter(r=>!filterPerson||r.person===filterPerson).forEach((r,i)=>{
    const tr=document.createElement("tr");
    const left=r.totalCost-r.amountPaid; total+=r.totalCost;
    tr.innerHTML=`
      <td>${r.date}</td><td>${r.material}</td><td>${r.person}</td>
      <td>${r.totalCost}</td><td>${r.amountPaid}</td><td>${left}</td>
      <td class="history"><details><summary>View</summary>${r.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join("<br>")}</details></td>
      <td><button onclick="updatePaid(${i})">Update Paid</button> <button onclick="deleteRecord(${i})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("grandTotal").textContent=total;
}

function updatePaid(index){
  const add=parseFloat(prompt("Enter additional amount paid:"))||0;if(add<=0)return;
  const date=new Date().toLocaleDateString();
  records[index].amountPaid+=add;
  records[index].history.push({date,added:add,amountPaid:records[index].amountPaid});
  renderTable();
}
function deleteRecord(index){if(confirm("Delete this record?")){records.splice(index,1);renderTable();updatePersonFilter();}}

function getTotals(filteredRecords){
  let total=0,paid=0,left=0;
  filteredRecords.forEach(r=>{total+=r.totalCost;paid+=r.amountPaid;left+=r.totalCost-r.amountPaid;});
  return {total,paid,left};
}

// Export Excel (formatted)
function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws_data=[["Date","Material","Person","Total Cost","Paid","Left","History"]];
  const filterPerson=document.getElementById("personFilter").value;
  const exportRecords=filterPerson?records.filter(r=>r.person===filterPerson):records;
  exportRecords.forEach(r=>{
    const historyStr=r.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join("\n");
    ws_data.push([r.date,r.material,r.person,r.totalCost,r.amountPaid,r.totalCost-r.amountPaid,historyStr]);
  });
  const totals=getTotals(exportRecords);
  ws_data.push(["Grand Total","","",totals.total,totals.paid,totals.left,""]);

  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  const colWidths=[15,20,20,15,15,15,40];
  ws['!cols']=colWidths.map(w=>({wch:w}));
  XLSX.utils.book_append_sheet(wb,ws,"Records");
  XLSX.writeFile(wb,"Construction_Records.xlsx");
}

// Export PDF (formatted)
function exportPDF(){
  const { jsPDF }=window.jspdf; const doc=new jsPDF();
  doc.setFontSize(16); doc.text("House Cost of Construction",14,15);
  const filterPerson=document.getElementById("personFilter").value;
  const exportRecords=filterPerson?records.filter(r=>r.person===filterPerson):records;
  const tableData=exportRecords.map(r=>[
    r.date,r.material,r.person,r.totalCost,r.amountPaid,r.totalCost-r.amountPaid,
    r.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join("\n")
  ]);
  const totals=getTotals(exportRecords);
  tableData.push(["Grand Total","","",totals.total,totals.paid,totals.left,""]);
  doc.autoTable({
    head:[["Date","Material","Person","Total Cost","Paid","Left","History"]],
    body:tableData,
    startY:25,
    styles:{fontSize:10,cellPadding:3},
    headStyles:{fillColor:[0,119,204],textColor:255},
    alternateRowStyles:{fillColor:[240,240,240]},
    footStyles:{fillColor:[200,200,200],textColor:20,fontStyle:'bold'}
  });
  doc.save("Construction_Records.pdf");
}

renderTable();
</script>
</body>
</html>
