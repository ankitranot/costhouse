<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Cost Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2, h3 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    input[type="text"], input[type="number"] {
      padding: 5px; margin: 2px; width: 120px;
    }
    button { padding: 5px 10px; margin: 2px; cursor: pointer; }
    button.delete { background: red; color: #fff; }
    .totals-box { font-weight: bold; margin: 10px 0; }
    details { cursor: pointer; }
  </style>
</head>
<body>
  <h2>Construction Cost Tracker</h2>

  <!-- Input Form -->
  <div>
    <input type="text" id="person" placeholder="Person">
    <input type="text" id="category" placeholder="Category">
    <input type="number" id="total" placeholder="Total Cost">
    <button onclick="addRecord()">Add Record</button>
  </div>

  <!-- Records Table -->
  <h3>All Records (Grouped by Person)</h3>
  <table id="recordsTable">
    <thead>
      <tr>
        <th>Person</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Left</th>
        <th>Add Paid</th>
        <th>History</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Grand Total -->
  <div id="grandTotalBox" class="totals-box"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    // ðŸ”¹ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBV7tHimRYOI-zEN-4eythyPc39bafLHVY",
      authDomain: "costhouse25.firebaseapp.com",
      projectId: "costhouse25",
      storageBucket: "costhouse25.firebasestorage.app",
      messagingSenderId: "1031854363789",
      appId: "1:1031854363789:web:2db3e48f1c774a12297ec4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let records = [];

    // ðŸ”¹ Add Record
    async function addRecord() {
      const person = document.getElementById("person").value.trim();
      const category = document.getElementById("category").value.trim();
      const total = parseFloat(document.getElementById("total").value) || 0;
      if (!person || !category || total <= 0) return;

      const newRecord = {
        person,
        category,
        total,
        paid: 0,
        left: total,
        history: [`${category}: Added ${total} on ${new Date().toLocaleString()}`]
      };
      await db.collection("records").add(newRecord);

      document.getElementById("person").value = "";
      document.getElementById("category").value = "";
      document.getElementById("total").value = "";
    }

    // ðŸ”¹ Real-Time Listener
    db.collection("records").onSnapshot(snapshot => {
      records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderTable();
    });

    // ðŸ”¹ Render Table
    function renderTable() {
      const tbody = document.querySelector("#recordsTable tbody");
      tbody.innerHTML = "";

      const grouped = {};
      records.forEach(r => {
        if (!grouped[r.person]) grouped[r.person] = { total: 0, paid: 0, left: 0, history: [], ids: [] };
        grouped[r.person].total += r.total;
        grouped[r.person].paid += r.paid;
        grouped[r.person].left += r.left;
        grouped[r.person].history = grouped[r.person].history.concat(r.history);
        grouped[r.person].ids.push(r.id);
      });

      Object.entries(grouped).forEach(([person, vals]) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td data-label="Person">${person}</td>
          <td data-label="Total">${vals.total}</td>
          <td data-label="Paid">${vals.paid}</td>
          <td data-label="Left">${vals.left}</td>
          <td data-label="Add Paid">
            <div>
              <input type="number" placeholder="Add Paid" id="paid_${person}">
              <button onclick="updatePerson('${person}')">Update</button>
            </div>
          </td>
          <td data-label="History">
            <details><summary>Show</summary>${vals.history.join("<br>")}</details>
          </td>
          <td data-label="Delete"><button class="delete" onclick="deletePerson('${person}')">Delete</button></td>
        `;
        tbody.appendChild(row);
      });

      // Grand Total
      const totalSum = records.reduce((sum, r) => sum + r.total, 0);
      document.getElementById("grandTotalBox").textContent = "Grand Total: " + totalSum;
    }

    // ðŸ”¹ Update Person (distribute Paid correctly)
    async function updatePerson(person) {
      let paidInput = parseFloat(document.getElementById(`paid_${person}`).value) || 0;
      if (paidInput <= 0) return;

      const now = new Date().toLocaleString();
      const personDocs = records
        .filter(r => r.person === person && r.left > 0)
        .sort((a,b) => a.left - b.left); 

      for (const doc of personDocs) {
        if (paidInput <= 0) break;

        const docRef = db.collection("records").doc(doc.id);
        const data = (await docRef.get()).data();

        const availableLeft = data.total - data.paid;
        const payNow = Math.min(availableLeft, paidInput);

        const newPaid = data.paid + payNow;
        const newLeft = data.total - newPaid;
        const newHistory = [...data.history, `Paid ${payNow} on ${now}`];

        await docRef.update({ paid: newPaid, left: newLeft, history: newHistory });

        paidInput -= payNow;
      }

      document.getElementById(`paid_${person}`).value = "";
    }

    // ðŸ”¹ Delete Person
    async function deletePerson(person) {
      if (!confirm(`Delete all records for ${person}?`)) return;
      const personDocs = records.filter(r => r.person === person);
      for (const doc of personDocs) {
        await db.collection("records").doc(doc.id).delete();
      }
    }
  </script>
</body>
</html>
