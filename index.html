<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Construction Cost</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; color: #000; background: #fff; }
  h2 { font-weight: bold; font-size: 24px; margin-bottom: 20px; text-align: center; }
  .form-group { margin-bottom: 10px; }
  input, button, select { padding: 8px; margin-right: 5px; font-size: 14px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 15px; }
  th, td { border: 1px solid #000; padding: 8px; text-align: center; }
  th { background: #f2f2f2; }
  .history { margin-top: 10px; font-size: 13px; text-align: left; }
  .grand-total { font-weight: bold; font-size: 20px; text-align: center; margin-bottom: 20px; border: 2px solid #000; display: inline-block; padding: 10px 20px; }
  details { cursor: pointer; }
  @media(max-width:768px){
    input, button, select { width: 100%; margin-bottom: 8px; }
  }
</style>
</head>
<body>

<h2>Construction Cost</h2>
<div class="grand-total" id="grandTotalBox">Grand Total: 0</div>

<div class="form-group">
  <input type="text" id="material" placeholder="Material Name">
  <input type="number" id="cost" placeholder="Total Cost">
  <input type="number" id="paid" placeholder="Paid Amount">
  <input type="text" id="person" placeholder="Person Name">
  <button onclick="addOrUpdateRecord()">Add / Update</button>
</div>

<div class="form-group">
  <label>Filter by Person:</label>
  <select id="filterPerson" onchange="filterTable()">
    <option value="all">All</option>
  </select>
</div>

<table id="recordsTable">
  <thead>
    <tr>
      <th>Person</th>
      <th>Material</th>
      <th>Total Cost</th>
      <th>Paid</th>
      <th>Left</th>
      <th>Remarks</th>
      <th>History</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let records = [];

function addOrUpdateRecord() {
  const material = document.getElementById("material").value.trim();
  const cost = parseFloat(document.getElementById("cost").value) || 0;
  const paid = parseFloat(document.getElementById("paid").value) || 0;
  const person = document.getElementById("person").value.trim();

  if (!person || !material || cost <= 0) {
    alert("Please fill all required fields (Person, Material, Cost).");
    return;
  }

  let existingRecord = records.find(r => r.person === person);

  if (existingRecord) {
    existingRecord.total += cost;
    existingRecord.paid += paid;
    existingRecord.left = existingRecord.total - existingRecord.paid;
    existingRecord.remarks = existingRecord.left === 0 ? "Nil" : "";
    existingRecord.materials.push(material);
    existingRecord.history.push(`+${paid} paid on ${new Date().toLocaleString()} for ${material}`);
  } else {
    let left = cost - paid;
    records.push({
      person,
      materials: [material],
      total: cost,
      paid,
      left,
      remarks: left === 0 ? "Nil" : "",
      history: [`+${paid} paid on ${new Date().toLocaleString()} for ${material}`]
    });

    const filterSelect = document.getElementById("filterPerson");
    let option = document.createElement("option");
    option.value = person;
    option.textContent = person;
    filterSelect.appendChild(option);
  }

  renderTable();
  updateGrandTotal();

  document.getElementById("material").value = "";
  document.getElementById("cost").value = "";
  document.getElementById("paid").value = "";
  document.getElementById("person").value = "";
}

function renderTable() {
  const tbody = document.querySelector("#recordsTable tbody");
  tbody.innerHTML = "";
  const filter = document.getElementById("filterPerson").value;

  records.forEach((record, index) => {
    if (filter !== "all" && record.person !== filter) return;

    let row = `<tr>
      <td>${record.person}</td>
      <td>${record.materials.join(", ")}</td>
      <td>${record.total}</td>
      <td>${record.paid}</td>
      <td>${record.left}</td>
      <td>${record.remarks}</td>
      <td>
        <details>
          <summary>Show History</summary>
          <div class="history">${record.history.join("<br>")}</div>
        </details>
      </td>
      <td>
        <button onclick="updateRow(${index})">Update</button>
        <button onclick="deleteRecord(${index})">Delete</button>
      </td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

function deleteRecord(index) {
  if (confirm("Delete this record?")) {
    records.splice(index, 1);
    renderTable();
    updateGrandTotal();
  }
}

function updateRow(index) {
  const addCost = parseFloat(prompt("Enter additional cost:")) || 0;
  const addPaid = parseFloat(prompt("Enter additional paid amount:")) || 0;
  const addMaterial = prompt("Enter material name for this update:").trim();
  if (addCost <= 0 && addPaid <= 0) return;

  const record = records[index];
  record.total += addCost;
  record.paid += addPaid;
  record.left = record.total - record.paid;
  record.materials.push(addMaterial || "Updated");
  record.history.push(`+${addPaid} paid on ${new Date().toLocaleString()} for ${addMaterial || "Updated"}`);
  record.remarks = record.left === 0 ? "Nil" : "";

  renderTable();
  updateGrandTotal();
}

function updateGrandTotal() {
  const total = records.reduce((sum, r) => sum + r.total, 0);
  document.getElementById("grandTotalBox").textContent = "Grand Total: " + total;
}

function filterTable() {
  renderTable();
}
</script>

</body>
</html>
