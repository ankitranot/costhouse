<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>House Cost of Construction</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f8; }
h1 { text-align: center; }
.form-group { margin-bottom: 10px; }
label { display: inline-block; width: 120px; font-weight: bold; }
input, select { padding: 5px; width: 200px; }
button { padding: 6px 12px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top;}
th { background: #0077cc; color: #fff; }
tfoot td { font-weight: bold; }
.btn-update { background: #ff9800; color: #fff; }
.btn-delete { background: #f44336; color: #fff; }
.btn-export { background: #4caf50; color: #fff; }
.history { font-size: 12px; color: #555; margin-top: 5px; display: none; text-align: left; }
.show-history-btn { font-size: 12px; padding: 2px 5px; margin-top: 2px; cursor: pointer; background: #ddd; border-radius: 3px; }
</style>
</head>
<body>
<h1>Construction of House </h1>

<!-- Form to add record -->
<div class="form-group">
  <label>Material:</label>
  <input type="text" id="material">
</div>
<div class="form-group">
  <label>Person:</label>
  <input type="text" id="person">
</div>
<div class="form-group">
  <label>Total Cost:</label>
  <input type="number" id="totalCost">
</div>
<div class="form-group">
  <label>Amount Paid:</label>
  <input type="number" id="amountPaid">
</div>
<button onclick="addRecord()">Add Record</button>
<button class="btn-export" onclick="exportExcel()">Export Excel</button>
<button class="btn-export" onclick="exportPDF()">Export PDF</button>

<!-- Filter by person -->
<div class="form-group">
  <label>Filter Person:</label>
  <select id="personFilter" onchange="renderTable()">
    <option value="">All</option>
  </select>
</div>

<!-- Table -->
<table id="recordsTable">
<thead>
<tr>
<th>Date</th>
<th>Material</th>
<th>Person</th>
<th>Total Cost</th>
<th>Paid</th>
<th>Left</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td colspan="3">Grand Total</td>
<td id="grandTotal">0</td>
<td id="grandPaid">0</td>
<td id="grandLeft">0</td>
<td></td>
</tr>
</tfoot>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
let records = JSON.parse(localStorage.getItem("constructionRecords")) || [];

// Save to localStorage
function saveRecords() {
  localStorage.setItem("constructionRecords", JSON.stringify(records));
}

// Update person filter dropdown
function updatePersonFilter() {
  const select = document.getElementById("personFilter");
  const selected = select.value;
  const persons = [...new Set(records.map(r => r.person))].sort();
  select.innerHTML = '<option value="">All</option>';
  persons.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    select.appendChild(opt);
  });
  if ([...select.options].some(o=>o.value===selected)) select.value = selected;
}

// Toggle history visibility
function toggleHistory(id) {
  const div = document.getElementById(id);
  div.style.display = div.style.display === 'none' ? 'block' : 'none';
}

// Render table
function renderTable() {
  const tbody = document.querySelector("#recordsTable tbody");
  tbody.innerHTML = "";
  let total=0, paid=0, left=0;
  const filterPerson = document.getElementById("personFilter").value;
  const filteredRecords = filterPerson ? records.filter(r=>r.person===filterPerson):records;

  filteredRecords.forEach((rec,i)=>{
    const tr=document.createElement("tr");
    const leftAmount = rec.totalCost - rec.amountPaid;
    const historyId = "history-"+i;
    const historyHTML = rec.history ? rec.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join('<br>') : '';
    tr.innerHTML=`
      <td>${rec.date}</td>
      <td>${rec.material}</td>
      <td>${rec.person}</td>
      <td>${rec.totalCost}</td>
      <td>
        ${rec.amountPaid}
        <div class="show-history-btn" onclick="toggleHistory('${historyId}')">Show History</div>
        <div class="history" id="${historyId}">${historyHTML}</div>
      </td>
      <td>${leftAmount}</td>
      <td>
        <button class="btn-update" onclick="updatePaid(${records.indexOf(rec)})">Add Paid</button>
        <button class="btn-delete" onclick="deleteRecord(${records.indexOf(rec)})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
    total+=rec.totalCost;
    paid+=rec.amountPaid;
    left+=leftAmount;
  });
  document.getElementById("grandTotal").textContent=total;
  document.getElementById("grandPaid").textContent=paid;
  document.getElementById("grandLeft").textContent=left;
  updatePersonFilter();
}

// Add new record
function addRecord() {
  const material = document.getElementById("material").value.trim();
  const person = document.getElementById("person").value.trim();
  const totalCost = parseFloat(document.getElementById("totalCost").value)||0;
  const amountPaid = parseFloat(document.getElementById("amountPaid").value)||0;
  if(!material||!person){alert("Please enter Material and Person name."); return;}
  const today = new Date().toLocaleDateString("en-GB");
  const rec = {date:today,material,person,totalCost,amountPaid,history:[{date:today,added:amountPaid,amountPaid:amountPaid}]};
  records.push(rec);
  saveRecords();
  renderTable();
  document.getElementById("material").value="";
  document.getElementById("person").value="";
  document.getElementById("totalCost").value="";
  document.getElementById("amountPaid").value="";
}

// Update Paid Amount (add to existing)
function updatePaid(index) {
  const addPaid = prompt("Enter amount to add to Paid Amount:", "0");
  if (addPaid !== null) {
    const addedAmount = parseFloat(addPaid) || 0;
    records[index].amountPaid += addedAmount;
    const today = new Date().toLocaleDateString("en-GB");
    if(!records[index].history) records[index].history=[];
    records[index].history.push({ date: today, added: addedAmount, amountPaid: records[index].amountPaid });
    saveRecords();
    renderTable();
  }
}

// Delete record
function deleteRecord(index){
  if(confirm("Are you sure to delete this record?")){
    records.splice(index,1);
    saveRecords();
    renderTable();
  }
}

// Totals
function getTotals(arr=records){
  let total=0, paid=0, left=0;
  arr.forEach(r=>{total+=r.totalCost; paid+=r.amountPaid; left+=r.totalCost-r.amountPaid;});
  return {total,paid,left};
}

// Export Excel
function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws_data=[["Date","Material","Person","Total Cost","Paid","Left","History"]];
  const filterPerson = document.getElementById("personFilter").value;
  const exportRecords = filterPerson?records.filter(r=>r.person===filterPerson):records;
  exportRecords.forEach(r=>{
    const historyStr = r.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join("\n");
    ws_data.push([r.date,r.material,r.person,r.totalCost,r.amountPaid,r.totalCost-r.amountPaid,historyStr]);
  });
  ws_data.push(["Grand Total","","",getTotals(exportRecords).total,getTotals(exportRecords).paid,getTotals(exportRecords).left,""]);
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Records");
  XLSX.writeFile(wb,"Construction_Records.xlsx");
}

// Export PDF
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("House Cost of Construction",14,15);
  const filterPerson = document.getElementById("personFilter").value;
  const exportRecords = filterPerson?records.filter(r=>r.person===filterPerson):records;
  const tableData = exportRecords.map(r=>[
    r.date,r.material,r.person,r.totalCost,r.amountPaid,r.totalCost-r.amountPaid,
    r.history.map(h=>`${h.date}: +${h.added} → Total ${h.amountPaid}`).join("\n")
  ]);
  tableData.push(["Grand Total","","",getTotals(exportRecords).total,getTotals(exportRecords).paid,getTotals(exportRecords).left,""]);
  doc.autoTable({head:[["Date","Material","Person","Total Cost","Paid","Left","History"]],body:tableData,startY:20});
  doc.save("Construction_Records.pdf");
}

// Initial render
renderTable();
</script>
</body>
</html>
